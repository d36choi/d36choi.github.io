---
layout: post
title: item 76 가능한 한 실패 원자적으로 만들라
date: 2024-05-26 10:30 +0900
categories: ["이펙티브 자바"]
tags: [java]
---

## 호출된 메서드가 실패하더라도 해당 객체는 메서드 호출 전 상태를 유지해야 한다

- 이런 특성을 실패 원자적이라고 한다

## 방법

- 불변객체로 설계하라. 불변 객체는 태생적으로 실패 원자적이다
- 예외에 빠져도 기존 객체가 변경될 일은 결코 없을 것이다. 불변객체의 특성이 그러하니까

## 가변객체의 경우엔?

- 작업 수행에 앞서 매개변수의 유효성을 점검하라. item 49
- 객체의 내부상태변경 전 잠재적 예외 가능성을 걸러낼 수 있는 방법

```java
public Object pop() {
   if (size == 0)
      throw new EmptyStackException();
   Object result = elements[--size];
   elements[size] = null; // 다 쓴 참조 해제
   return result;
}
```

-  if 문에서 size 값을 확인하여 예외를 던진다
- 이와 비슷하게, 실패 가능성이 있는 모든 코드를 객체 상태를 바꾸는 코드보다 앞에 배치하는 방법도 있다
- TreeMap의 경우 순서 정렬을 위해 원소 추가시 Comparable 한 타입이어야 한다
- 엉뚱한 원소를 추가하려 들면 ClassCastException을 던질 것이다

## 임시 복사본에서 작업을 수행한다음 성공하면 원래와 교체하는 방법

- 데이터를 임시 자료구조에 저장해 작업하는게 더 빠를때 적용하기 좋다

## 복구코드를 작성하여 작업 전상태로 보정하는 방법
- 디스크 기반의 내구성을 보장해야하는 자료구조에 쓰임
- 자주 쓰이는 방법은 아니다

## 실패 원자성이 항상 달성가능한 것은 아니다
- 두 스레드가 동기화없이 같은 객체를 수정한다면 일관성이 깨질 수 있다
- AssertionError는 복구할 수 없기에 실패원자적으로 만들 시도조차 안한다
- 실패원자성을 달성하기 위해선 비용이나 복잡도가 너무 큰 연산도 존재한다
