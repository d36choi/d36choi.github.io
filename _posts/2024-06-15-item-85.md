---
layout: post
title: item 85 자바 직렬화의 대안을 찾아라
date: 2024-06-15 23:01 +0900
categories: ["이펙티브 자바"]
tags: [java]
---

# 자바의 직렬화는 큰 문제가 존재

- 보안우려가 심각하다
- `ObjectInputStream.readObject()`는 객체 그래프의 역직렬화가 진행됨
- 이건 사실상 클래스패스 안 거의 모든 타입의 객체를 만들어 낼 수 있는 마법같은 존재임
- 바이트스트림 역직렬화 과정에서 그 타입들안의 모든 코드를 수행한다
- 즉 이로 인해 디도스나 원격코드실행에 노출될 수 있다


## 그 범위는?
- 표준 라이브러리와 아파치 커먼즈 컬렉션같은 서드파티도 모두 취약하다

## 가젯?
- 이런 역직렬화 과정에서 호출되어 잠재적으로 위험한 동작을 수행하는 메서드들을 의미
- 이런 가젯은 하드웨어 네이티브 코드까지 건드릴 수 있기에 매우 위험
- 따라서 아주 신중하게 제작된 바이트스트림만 역직렬화해야함

## 역직렬화 폭탄

```java
// 역직렬화 폭탄 - 이 스트림의 역직렬화는 영원히 계속된다.
static byte[] bomb() {
    Set<Object> root = new HashSet<>();
    Set<Object> s1 = root;
    Set<Object> s2 = new HashSet<>();

    for (int i=0; i < 100; i++) {
        Set<Object> t1 = new HashSet<>();
        Set<Object> t2 = new HashSet<>();

        t1.add("foo"); // t1을 t2과 다르게 만든다.
        s1.add(t1); s1.add(t2);

        s2.add(t1); s2.add(t2);
        s1 = t1; s2 = t2;
    }
    return serialize(root);
}
```

- 이 HashSet을 역직렬화 하기 위해서는 hashCode 메서드를 2^100호출해야 하며 사실상 영원히 걸린다


## 대처법
- 아예 이런 신뢰할 수 없는 바이트 스트림을 역직렬화 하지 말자
- **우리가 작성하는 새 시스템에서 자바 직렬화를 써야할 이유가 없다**

# 크로스플랫폼 구조화 데이터 표현을 사용하자

## JSON
- JSON 은 브라우저 서버 통신용으로 설계
- 텍스트 기반. 자바스크립트 용으로 개발
- 데이터 표현을 위해서만 사용

## 프로토콜 버퍼
- 서버 사이에 데이터를 교환하고 저장하기 위해 설계
- 씨++ 용으로 만듬
- 문서 스키마타입을 제공하고 올바르게 쓰도록 강요
- 효율이 훨씬 좋지만 텍스트기반은 JSON 이 효율적

## 차선책
- 레거시때문에 직렬화를 배제할 수 없는경우에는 신뢰할수없는 데이터의 경우 역직렬화 하지 않는 것이 제일 중요
- 역직렬화 데이터가 안전한지 확신할 수 없다면 객체 역직렬화 필터링을 사용하자(자바9)
- 블랙리스트 방식보다 화이트리스트 방식을 이용하자


- 
