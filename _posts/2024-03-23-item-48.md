---
layout: post
title: item-48 스트림 병렬화는 주의해서 사용하라
date: 2024-03-23 21:55 +0900
categories: ["이펙티브 자바"]
tags: [java]
---


# item 48 스트림 병렬화는 주의해서 사용하라

> 자바는 주류 언어중, 동시성 프로그래밍 측면에서 항상 앞서갔다.

- 첫 릴리즈때 스레드,동기화,wait/notify지원
- 5버전부터 java.util.concurrent 패키지와 executor 프레임워크 지원
- 7부터 fork-join 패키지 추가
- 8부터 pararllel 메서드만 호출하면 파이프라인을 병렬 실행 가능하게 함

## 동시성 프로그래밍에서 중요한건 안전성과 응답가능 상태를 유지하는 것
- 환경이 아무리 좋더라도 데이터 소스가 Stream.iterate이거나 중간 연산에 limit() 을 쓰면 파이프라인 병렬화로 스트림 성능개선은 불가
- 메르센 소수 구하기 알고리즘의 경우, 다음 1개 작업이 이전의 모든 작업 시간을 합친 것 보다 오래걸림
- 이 경우, cpu 4개 코어에서 동시에 작업을 하더라도 1개 작업이 끝나더라도 나머지 코어의 작업은 끝나지 않음
- 이런 병렬화는 결국 아무런 도움이 되지 못함

## 스트림 소스가 ArrayList,HashMap,HashSet,ConcurrentHashMap 인스턴스거나 Array, int, long 일 때 병렬화효과가 좋다

- 이 자료구조들은 참조 지역성이 뛰어나다. 참조 지역성이란 데이터가 메모리에 연속적으로 위치해 저장되어있다는 것
- 참조 지역성이란? **시간 지역성(데이터가 반복해서 참조될 가능성)**과 **공간 지역성(인접한 데이터가 함께 참조될 가능성)** 으로 나뉨

## 종단 연산 중 가장 병렬 수행 효과가 좋은건 축소(reduction) 이다

- reduce()나 min,max,count,sum 같이 모든 원소를 하나로 합치는 작업을 의미
- anyMatch,allMatch,noneMatch 처럼 조건에 맞으면 바로 반환되는 메서드도 적합하다
- **collect 는 적합하지 않다.** 그 이유는 컬렉션을 합치는 비용이 크기때문

## 스트림의 안전 실패 (safety failure) 를 주의하자

> 스트림을 잘못 병렬화하면 성능이 나빠질 뿐 아니라 결과자체가 잘못되거나, 예상못한 동작이 발생한다.

- 이를 방지하기 위해 Stream 에는 규약이 정해져있다.
1. 결합법칙을 만족 - 연산의 순서가 바뀌어도 결과가 동일. (a+b)+c = a+(b+c)
2. 간섭받지 않음 - 파이프라인 수행하는 동안 데이터소스는 변해서는 안됨
3. 무상태 - stateless


## 스트림 병렬화는 오로지 최적화 수단임을 기억해야 한다
- 파이프라인의 작업량보다 병렬화에 드는 추가비용이 크지 않다면 성능 향상은 미비하다
- 간단 계산법: **스트림 원소수 * 원소당 수행되는 코드의 라인수**
- 이 값이 최소 수십만은 되어야 성능 개선이 있다고 할 수 있다
- 성능 테스트를 해 병렬화의 가치가 있는지 확인해야한다


## 결론

- 계산이 제대로 수행되고 성능이 빨라진단 확신이 없이는 스트림 병렬화는 시도도 하지말라
- 오동작, 성능 저하가 발생할 수 있다
- 만약 사용한다면 수정 후 코드를 운영과의 유사 환경에서 실행하면서 성능지표를 유심히 살펴라
